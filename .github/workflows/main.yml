# main deploy to hosting server. real bitch to set up.
# methods gleaned from this beautiful post :3
# https://zellwk.com/blog/github-actions-deploy/

# DEPLOY VIA SSH + RSYNC - COMPLETE SETUP GUIDE
# 
# === INITIAL SETUP (ONE TIME) ===
# 
# 1. SSH INTO YOUR SERVER & GENERATE KEY
#    ssh user@your-server
#    cd ~/.ssh
#    ssh-keygen -t rsa -b 4096 -C "your@email.com"
#    # Name it: github-actions (NOT id_rsa)
#    # Leave passphrase empty
# 
# 2. ADD PUBLIC KEY TO AUTHORIZED_KEYS
#    cat github-actions.pub >> ~/.ssh/authorized_keys
#    # IMPORTANT: Use >> (append) NOT > (overwrite)
# 
# 3. ADD PRIVATE KEY TO GITHUB SECRETS
#    - Go to repo Settings â†’ Secrets â†’ New repository secret
#    - Name: SSH_PRIVATE_KEY
#    - Value: Copy entire github-actions file (nano github-actions)
#      Include everything from "-----BEGIN..." to "-----END..."
# 
# 4. ADD OTHER SECRETS TO GITHUB
#    - SSH_HOST: Your server's IP address
#    - SSH_USER: Your SSH username (e.g., root, ubuntu, etc.)
# 

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ['main']
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

    
name: publish to server
jobs:
  web-deploy:
    name: ðŸ´ deploy on commit
    runs-on: ubuntu-latest
    steps:
    - name: checkout
      uses: actions/checkout@v4

    - name: set up node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'

    - name: install dependencies
      run: npm ci

    - name: build
      run: npm run build

    - name: Install SSH Key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        known_hosts: 'just-a-placeholder-so-we-dont-get-errors'

    - name: add known hosts
      run: ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy with rsync
      run: rsync -avz ./dist/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/${{ secrets.SSH_USER }}/john-trinh.com